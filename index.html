<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#002d72">
    <title>Peugeot Manager Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { 
            --primary: #002d72; 
            --bg: #f2f4f8; 
            --fuel: #e65100;
            --maint: #2e7d32;
            --text-dark: #333;
        }
        
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; padding-bottom: 80px; color: var(--text-dark); }
        .card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); width: 100%; max-width: 600px; margin-bottom: 15px; box-sizing: border-box; border-top: 5px solid var(--primary); }
        
        h2 { text-align: center; color: var(--primary); margin: 0 0 10px 0; text-transform: uppercase; font-size: 1.3rem; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #eee; padding: 4px; border-radius: 10px; }
        .tab { flex: 1; padding: 10px; border: none; background: transparent; color: #666; font-weight: 600; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .full { grid-column: span 2; }
        label { display: block; font-size: 0.7em; font-weight: 700; color: #555; margin-bottom: 3px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; font-size: 1rem; box-sizing: border-box; }
        
        .file-box { border: 2px dashed #ccc; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; background: #f9f9f9; font-size: 0.9em; }
        .file-box.active { border-color: var(--maint); background: #e8f5e9; color: var(--maint); }
        
        .btn-main { width: 100%; padding: 14px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; font-size: 1rem; margin-top: 5px; cursor: pointer; }
        .btn-cancel { width: 100%; padding: 10px; background: #ccc; color: #333; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; display: none; cursor: pointer; }
        .editing .btn-cancel { display: block; }
        .editing .btn-main { background: #fbc02d; color: #000; }

        .summary-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; text-align: center; }
        .stat-card { background: #f8f9fa; padding: 10px; border-radius: 12px; border: 1px solid #eee; }
        .stat-card b { font-size: 1.1rem; display: block; }
        .stat-card span { font-size: 0.7rem; color: #666; text-transform: uppercase; }

        .month-block { margin-bottom: 10px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; background: white; }
        .month-header { background: #e3f2fd; padding: 12px; font-weight: bold; color: var(--primary); display: flex; justify-content: space-between; cursor: pointer; }
        .month-body { display: none; }
        .month-body.open { display: block; }

        .item-row { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .item-row:last-child { border-bottom: none; }
        .item-type-fuel { border-left: 4px solid var(--fuel); }
        .item-type-maint { border-left: 4px solid var(--maint); }
        
        .item-details { display: none; background: #fafafa; padding: 10px; border-top: 1px solid #eee; font-size: 0.9em; color: #555; }
        .item-details.open { display: block; }
        
        .action-bar { display: flex; gap: 10px; margin-top: 10px; }
        .btn-act { padding: 5px 10px; border-radius: 4px; border: none; font-size: 0.8em; color: white; cursor: pointer; }
        
        .backup-area { margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
    </style>
</head>
<body>

<div class="card">
    <h2>Peugeot 208 Manager</h2>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('fuel')">‚õΩ Carburante</button>
        <button class="tab" onclick="switchTab('maint')">üîß Manutenzione</button>
        <button class="tab" onclick="switchTab('history')">üìä Storico</button>
    </div>

    <div id="fuel" class="form-section active">
        <input type="hidden" id="f_id">
        <div class="grid">
            <div class="full"><label>Data</label><input type="date" id="f_date"></div>
            <div><label>Km Attuali</label><input type="number" id="f_km"></div>
            <div><label>‚Ç¨ / Litro</label><input type="number" id="f_price" step="0.001" oninput="calcFuel()"></div>
            <div><label>Litri</label><input type="number" id="f_liters" step="0.01" oninput="calcFuel()"></div>
            <div><label>Totale ‚Ç¨</label><input type="number" id="f_total" step="0.01"></div>
        </div>
        <div class="full">
            <div class="file-box" id="f_box" onclick="document.getElementById('f_file').click()">üì∏ Allega Scontrino</div>
            <input type="file" id="f_file" hidden accept="image/*,application/pdf" onchange="loadFile(this, 'f_box')">
        </div>
        <button class="btn-main" id="btnF" onclick="saveFuel()">üíæ Salva Rifornimento</button>
        <button class="btn-cancel" onclick="resetForm()">‚ùå Annulla Modifica</button>
    </div>

    <div id="maint" class="form-section">
        <input type="hidden" id="m_id">
        <div class="grid">
            <div class="full"><label>Data</label><input type="date" id="m_date"></div>
            <div class="full"><label>Km Attuali</label><input type="number" id="m_km"></div>
            <div class="full"><label>Tipo Intervento</label>
                <select id="m_type">
                    <option value="Tagliando">üõ¢Ô∏è Tagliando</option>
                    <option value="Riparazione">üîß Riparazione</option>
                    <option value="Gomme">üõû Gomme</option>
                    <option value="Revisione">üìã Revisione</option>
                    <option value="Bollo">üìë Bollo</option>
                    <option value="Altro">üìù Altro</option>
                </select>
            </div>
            <div><label>Ricambi ‚Ç¨</label><input type="number" id="m_parts" step="0.01" value="0" oninput="calcMaint()"></div>
            <div><label>Manodopera ‚Ç¨</label><input type="number" id="m_labor" step="0.01" value="0" oninput="calcMaint()"></div>
            <div class="full"><label>Totale ‚Ç¨</label><input type="number" id="m_total" step="0.01" value="0" style="font-weight:bold; background:#e8f5e9"></div>
            <div class="full"><label>Note</label><textarea id="m_notes" rows="2"></textarea></div>
        </div>
        <div class="full">
            <div class="file-box" id="m_box" onclick="document.getElementById('m_file').click()">üìÑ Allega Documento</div>
            <input type="file" id="m_file" hidden accept="image/*,application/pdf" onchange="loadFile(this, 'm_box')">
        </div>
        <button class="btn-main" id="btnM" style="background:var(--maint)" onclick="saveMaint()">üíæ Salva Manutenzione</button>
        <button class="btn-cancel" onclick="resetForm()">‚ùå Annulla Modifica</button>
    </div>

    <div id="history" class="form-section">
        <div class="summary-box">
            <div class="stat-card" style="border-left: 4px solid var(--fuel)">
                <span style="color:var(--fuel)">Diesel</span>
                <b id="tot_fuel">‚Ç¨ 0.00</b>
            </div>
            <div class="stat-card" style="border-left: 4px solid var(--maint)">
                <span style="color:var(--maint)">Manutenzione & Tasse</span>
                <b id="tot_maint">‚Ç¨ 0.00</b>
            </div>
            <div class="stat-card" style="grid-column: span 2; background: #e3f2fd; border-top: 1px solid var(--primary)">
                <span style="color:var(--primary)">Totale Complessivo</span>
                <b id="st_tot" style="font-size: 1.4rem">‚Ç¨ 0.00</b>
            </div>
        </div>

        <div style="height:200px; margin-bottom:20px"><canvas id="chart"></canvas></div>
        <div id="history-container"></div>
        <div class="backup-area">
            <button class="btn-act" style="background:#2e7d32" onclick="exportExcel()">üìä Excel</button>
            <button class="btn-act" style="background:#d32f2f" onclick="exportPDF()">üìÑ PDF</button>
            <button class="btn-act" style="background:#0277bd" onclick="exportBackup()">üì• Backup</button>
            <button class="btn-act" style="background:#f57c00" onclick="document.getElementById('impFile').click()">üì§ Restore</button>
            <input type="file" id="impFile" hidden accept=".json" onchange="importBackup(this)">
        </div>
    </div>
</div>

<script>
const DB_NAME = 'peugeot_db_pro';
let tempFile = null;
let chartRef = null;

window.onload = () => { resetForm(); render(); };

function formatDate(dateStr) {
    if(!dateStr) return "";
    const [y, m, d] = dateStr.split('-');
    return `${d}/${m}/${y}`;
}

function switchTab(id) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById(id).classList.add('active');
    if(id === 'history') { resetForm(); render(); }
}

function calcFuel() {
    const p = parseFloat(document.getElementById('f_price').value) || 0;
    const l = parseFloat(document.getElementById('f_liters').value) || 0;
    if(p && l) document.getElementById('f_total').value = (p * l).toFixed(2);
}
function calcMaint() {
    const p = parseFloat(document.getElementById('m_parts').value) || 0;
    const l = parseFloat(document.getElementById('m_labor').value) || 0;
    document.getElementById('m_total').value = (p + l).toFixed(2);
}

function loadFile(input, boxId) {
    const f = input.files[0];
    if(f) {
        if(f.size > 2000000) return alert("File troppo grande (Max 2MB)");
        const r = new FileReader();
        r.onload = (e) => {
            tempFile = { name: f.name, data: e.target.result };
            document.getElementById(boxId).innerText = "üìé " + f.name;
            document.getElementById(boxId).classList.add('active');
        };
        r.readAsDataURL(f);
    }
}

function getDb() { return JSON.parse(localStorage.getItem(DB_NAME)) || []; }
function setDb(d) { localStorage.setItem(DB_NAME, JSON.stringify(d)); }

function saveFuel() {
    const km = document.getElementById('f_km').value;
    if(!km) return alert("Inserisci i KM");
    const id = document.getElementById('f_id').value;
    const existing = id ? getDb().find(x => x.id == id) : null;
    const record = {
        id: id || Date.now(),
        type: 'fuel',
        date: document.getElementById('f_date').value,
        km: parseFloat(km),
        price: parseFloat(document.getElementById('f_price').value) || 0,
        lit: parseFloat(document.getElementById('f_liters').value) || 0,
        cost: parseFloat(document.getElementById('f_total').value) || 0,
        file: tempFile || (existing ? existing.file : null)
    };
    upsert(record);
}

function saveMaint() {
    const km = document.getElementById('m_km').value;
    if(!km) return alert("Inserisci i KM");
    const id = document.getElementById('m_id').value;
    const existing = id ? getDb().find(x => x.id == id) : null;
    const record = {
        id: id || Date.now(),
        type: 'maint',
        subtype: document.getElementById('m_type').value,
        date: document.getElementById('m_date').value,
        km: parseFloat(km),
        parts: parseFloat(document.getElementById('m_parts').value) || 0,
        labor: parseFloat(document.getElementById('m_labor').value) || 0,
        cost: parseFloat(document.getElementById('m_total').value) || 0,
        notes: document.getElementById('m_notes').value,
        file: tempFile || (existing ? existing.file : null)
    };
    upsert(record);
}

function upsert(rec) {
    let db = getDb();
    const idx = db.findIndex(x => x.id == rec.id);
    if(idx >= 0) db[idx] = rec; else db.push(rec);
    db.sort((a,b) => new Date(b.date) - new Date(a.date));
    setDb(db);
    alert("Salvato!");
    switchTab('history');
}

function editItem(id) {
    const r = getDb().find(x => x.id == id);
    if(!r) return;
    if(r.type === 'fuel') {
        document.getElementById('fuel').classList.add('editing');
        document.getElementById('f_id').value = r.id;
        document.getElementById('f_date').value = r.date;
        document.getElementById('f_km').value = r.km;
        document.getElementById('f_price').value = r.price;
        document.getElementById('f_liters').value = r.lit;
        document.getElementById('f_total').value = r.cost;
        if(r.file) document.getElementById('f_box').innerText = "üìé File Presente";
        document.querySelector('.tab[onclick*="fuel"]').click();
        document.getElementById('btnF').innerText = "üîÑ Aggiorna Rifornimento";
    } else {
        document.getElementById('maint').classList.add('editing');
        document.getElementById('m_id').value = r.id;
        document.getElementById('m_date').value = r.date;
        document.getElementById('m_km').value = r.km;
        document.getElementById('m_type').value = r.subtype;
        document.getElementById('m_parts').value = r.parts;
        document.getElementById('m_labor').value = r.labor;
        document.getElementById('m_total').value = r.cost;
        document.getElementById('m_notes').value = r.notes;
        if(r.file) document.getElementById('m_box').innerText = "üìé File Presente";
        document.querySelector('.tab[onclick*="maint"]').click();
        document.getElementById('btnM').innerText = "üîÑ Aggiorna Manutenzione";
    }
}

function resetForm() {
    document.querySelectorAll('input').forEach(i => { if(i.type!='date') i.value=''; });
    document.querySelectorAll('textarea').forEach(i => i.value='');
    document.getElementById('f_id').value = '';
    document.getElementById('m_id').value = '';
    document.getElementById('f_date').valueAsDate = new Date();
    document.getElementById('m_date').valueAsDate = new Date();
    document.getElementById('fuel').classList.remove('editing');
    document.getElementById('maint').classList.remove('editing');
    document.querySelectorAll('.file-box').forEach(b => {
        b.classList.remove('active');
        b.innerText = b.id.includes('f') ? "üì∏ Allega Scontrino" : "üìÑ Allega Documento";
    });
    tempFile = null;
}

function render() {
    const db = getDb();
    const container = document.getElementById('history-container');
    container.innerHTML = "";
    
    let totalFuel = 0;
    let totalMaint = 0;
    let groups = {};

    db.forEach(r => {
        const costValue = parseFloat(r.cost);
        if (r.type === 'fuel') totalFuel += costValue;
        else totalMaint += costValue;

        const k = r.date.substring(0, 7);
        if(!groups[k]) groups[k] = { total: 0, items: [] };
        groups[k].total += costValue;
        groups[k].items.push(r);
    });

    document.getElementById('tot_fuel').innerText = "‚Ç¨ " + totalFuel.toFixed(2);
    document.getElementById('tot_maint').innerText = "‚Ç¨ " + totalMaint.toFixed(2);
    document.getElementById('st_tot').innerText = "‚Ç¨ " + (totalFuel + totalMaint).toFixed(2);

    const sortedKeys = Object.keys(groups).sort().reverse();
    const monthsMap = ["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];

    sortedKeys.forEach(key => {
        const [y, m] = key.split('-');
        const monthName = monthsMap[parseInt(m)-1];
        const g = groups[key];
        let html = `<div class="month-block">
            <div class="month-header" onclick="toggleMonth('${key}')"><span>${monthName} ${y}</span><span>‚Ç¨ ${g.total.toFixed(2)} ‚ñº</span></div>
            <div class="month-body" id="m-${key}">`;
        g.items.forEach(item => {
            const isFuel = item.type === 'fuel';
            let detailsHtml = `<div class="item-details" id="d-${item.id}">`;
            if(item.notes) detailsHtml += `<p>üìù <i>${item.notes}</i></p>`;
            if(isFuel) {
                detailsHtml += `<p>Litri: ${item.lit} | Prezzo: ‚Ç¨${item.price}/L</p>`;
            } else {
                detailsHtml += `<p>Ricambi: ‚Ç¨${item.parts} | Manodopera: ‚Ç¨${item.labor}</p>`;
            }
            if(item.file) detailsHtml += `<button class="btn-act" style="background:#555; margin-right:5px" onclick="showFile('${item.id}')">üìé Vedi Allegato</button>`;
            detailsHtml += `<div class="action-bar">
                    <button class="btn-act" style="background:#fbc02d; color:black" onclick="editItem('${item.id}')">‚úèÔ∏è Modifica</button>
                    <button class="btn-act" style="background:#c62828" onclick="delItem('${item.id}')">üóëÔ∏è Elimina</button>
                </div></div>`;
            html += `<div class="item-row ${isFuel?'item-type-fuel':'item-type-maint'}" onclick="toggleDetails('${item.id}')">
                <div><b>${isFuel?'‚õΩ Rifornimento':'üîß '+item.subtype}</b> <span style="font-size:0.8em; color:#888">(${formatDate(item.date)})</span><br><small>Km: ${item.km}</small></div>
                <b>‚Ç¨${item.cost.toFixed(2)}</b></div>${detailsHtml}`;
        });
        html += `</div></div>`;
        container.innerHTML += html;
    });
    drawChart(db);
}

function toggleMonth(key) { document.getElementById('m-'+key).classList.toggle('open'); }
function toggleDetails(id) { document.getElementById('d-'+id).classList.toggle('open'); }
function delItem(id) { if(confirm("Eliminare?")) { setDb(getDb().filter(x => x.id != id)); render(); } }
function showFile(id) {
    const f = getDb().find(x=>x.id==id).file;
    const w = window.open("");
    if(f.data.startsWith("data:app")) w.document.write(`<iframe src="${f.data}" style="width:100%;height:100%"></iframe>`);
    else w.document.write(`<img src="${f.data}" style="width:100%">`);
}

function drawChart(db) {
    const ctx = document.getElementById('chart').getContext('2d');
    if(chartRef) chartRef.destroy();
    const data = [...db].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-15);
    chartRef = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(x => formatDate(x.date)),
            datasets: [{ label: 'Spesa', data: data.map(x => x.cost), borderColor: '#002d72', backgroundColor: 'rgba(0,45,114,0.1)', fill: true, tension: 0.3 }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Report Peugeot 208", 14, 15);
    const db = getDb();
    const rows = db.map(r => [formatDate(r.date), r.type==='fuel'?'Carburante':r.subtype, r.km, "‚Ç¨ "+r.cost.toFixed(2), r.notes || ""]);
    doc.autoTable({ head: [['Data', 'Tipo', 'Km', 'Costo', 'Note']], body: rows, startY: 20 });
    doc.save("Report_Peugeot.pdf");
}

function exportExcel() {
    const db = getDb();
    let csv = "Data;Tipo;Dettaglio;Km;Costo;Note\n";
    db.forEach(r => {
        let det = r.type==='fuel' ? 'Litri: '+r.lit : r.subtype;
        csv += `${formatDate(r.date)};${r.type};${det};${r.km};${r.cost};${r.notes||''}\n`;
    });
    const blob = new Blob([csv], {type: "text/csv"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "export.csv";
    a.click();
}

function exportBackup() {
    const blob = new Blob([localStorage.getItem(DB_NAME)], {type: "application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "backup.json";
    a.click();
}

function importBackup(input) {
    const r = new FileReader();
    r.onload = (e) => { localStorage.setItem(DB_NAME, e.target.result); alert("Ripristinato!"); location.reload(); };
    r.readAsText(input.files[0]);
}
</script>
</body>
</html>
