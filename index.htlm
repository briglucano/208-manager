<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#002d72">
    <title>Peugeot 208 Manager Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #002d72; 
            --bg: #f2f4f8; 
            --fuel: #e65100;
            --maint: #2e7d32;
            --edit: #fbc02d;
            --text-dark: #333;
        }
        
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 12px; margin: 0; padding-bottom: 80px; color: var(--text-dark); }
        
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); width: 100%; max-width: 600px; margin-bottom: 15px; box-sizing: border-box; border-top: 5px solid var(--primary); }
        
        h2 { text-align: center; color: var(--primary); margin: 0; text-transform: uppercase; font-size: 1.4rem; }
        .badge { display: block; text-align: center; background: #e3f2fd; color: #0d47a1; font-size: 0.75em; padding: 4px 10px; border-radius: 20px; width: fit-content; margin: 5px auto 15px auto; font-weight: bold; }
        
        /* TABS */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #fff; padding: 5px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 12px; border: none; background: transparent; color: #777; font-weight: 600; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(0,45,114,0.2); }
        
        /* FORMS */
        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .full { grid-column: span 2; }
        
        label { display: block; font-size: 0.75em; font-weight: 700; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; background: #fafafa; font-size: 1rem; box-sizing: border-box; -webkit-appearance: none; }
        input:focus { border-color: var(--primary); background: #fff; outline: none; }
        
        /* FILE UPLOAD */
        .file-box { border: 2px dashed #ccc; padding: 15px; text-align: center; border-radius: 10px; cursor: pointer; background: #f9f9f9; }
        .file-box.active { border-color: var(--maint); background: #e8f5e9; color: var(--maint); font-weight: bold; }
        .file-warn { color: #c62828; font-size: 0.8em; margin-top: 5px; display: none; }

        /* BUTTONS */
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: bold; font-size: 1rem; margin-top: 10px; cursor: pointer; }
        .btn-cancel { width: 100%; padding: 12px; background: #e0e0e0; color: #333; border: none; border-radius: 10px; font-weight: bold; margin-top: 8px; display: none; cursor: pointer; }
        .editing-mode .btn-main { background: var(--edit); color: #333; }
        .editing-mode .btn-cancel { display: block; }

        /* HISTORY */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
        .stat-box b { display: block; font-size: 1.1em; color: var(--primary); margin-top: 4px; }
        .stat-box small { font-size: 0.65em; color: #888; font-weight: bold; }

        .list-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #ccc; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .type-fuel { border-left-color: var(--fuel); }
        .type-maint { border-left-color: var(--maint); }
        .item-details h4 { margin: 0; font-size: 1rem; }
        .item-details p { margin: 4px 0 0 0; font-size: 0.8em; color: #666; }
        .item-actions { display: flex; gap: 10px; align-items: center; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; opacity: 0.6; }
        
        /* FOOTER ACTIONS */
        .backup-area { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .btn-small { padding: 8px 12px; font-size: 0.8em; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; }
    </style>
</head>
<body>

<div class="card">
    <h2>Peugeot 208 HDi</h2>
    <span class="badge">Gestione Veicolo</span>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('fuel')">‚õΩ Rifornimento</button>
        <button class="tab" onclick="switchTab('maint')">üîß Manutenzione</button>
        <button class="tab" onclick="switchTab('history')">üìä Storico</button>
    </div>

    <div id="fuel" class="form-section active">
        <input type="hidden" id="f_id"> <div class="grid">
            <div class="full"><label>Data</label><input type="date" id="f_date"></div>
            <div><label>Km Totali</label><input type="number" id="f_km"></div>
            <div><label>‚Ç¨ / Litro</label><input type="number" id="f_price" step="0.001" oninput="calcFuel()"></div>
            <div><label>Litri</label><input type="number" id="f_liters" step="0.01" oninput="calcFuel()"></div>
            <div><label>Totale ‚Ç¨</label><input type="number" id="f_total" step="0.01"></div>
        </div>
        
        <div class="full">
            <label>Scontrino (Max 1MB)</label>
            <div class="file-box" id="f_box" onclick="document.getElementById('f_file').click()">üì∏ Allega Foto/PDF</div>
            <input type="file" id="f_file" hidden accept="image/*,application/pdf" onchange="loadFile(this, 'f_box')">
            <div id="f_warn" class="file-warn">File troppo grande!</div>
        </div>

        <button id="btnSaveFuel" class="btn-main" onclick="saveFuel()">üíæ Salva Rifornimento</button>
        <button id="btnCancelFuel" class="btn-cancel" onclick="resetAll()">‚ùå Annulla Modifica</button>
    </div>

    <div id="maint" class="form-section">
        <input type="hidden" id="m_id"> <div class="grid">
            <div class="full"><label>Data</label><input type="date" id="m_date"></div>
            <div class="full"><label>Km Totali</label><input type="number" id="m_km"></div>
            
            <div class="full"><label>Tipo Intervento</label>
                <select id="m_type">
                    <option value="Tagliando">üõ¢Ô∏è Tagliando</option>
                    <option value="Riparazione">üîß Riparazione</option>
                    <option value="Gomme">üõû Gomme</option>
                    <option value="Revisione">üìã Revisione/Bollo</option>
                    <option value="Altro">üìù Altro</option>
                </select>
            </div>
            
            <div><label>Costo Ricambi ‚Ç¨</label><input type="number" id="m_parts" step="0.01" oninput="calcMaint()"></div>
            <div><label>Manodopera ‚Ç¨</label><input type="number" id="m_labor" step="0.01" oninput="calcMaint()"></div>
            <div class="full"><label>Totale Intervento ‚Ç¨</label><input type="number" id="m_total" step="0.01" style="font-weight:bold; background:#e8f5e9;"></div>

            <div class="full"><label>Note</label><textarea id="m_notes" rows="2"></textarea></div>
        </div>

        <div class="full">
            <label>Fattura (Max 1MB)</label>
            <div class="file-box" id="m_box" onclick="document.getElementById('m_file').click()">üìÑ Allega Documento</div>
            <input type="file" id="m_file" hidden accept="image/*,application/pdf" onchange="loadFile(this, 'm_box')">
            <div id="m_warn" class="file-warn">File troppo grande!</div>
        </div>

        <button id="btnSaveMaint" class="btn-main" style="background:var(--maint)" onclick="saveMaint()">üíæ Salva Manutenzione</button>
        <button id="btnCancelMaint" class="btn-cancel" onclick="resetAll()">‚ùå Annulla Modifica</button>
    </div>

    <div id="history" class="form-section">
        <div class="stat-grid">
            <div class="stat-box"><small>SPESA TOT.</small><b id="st_cost">‚Ç¨0</b></div>
            <div class="stat-box"><small>KM MEDIO/L</small><b id="st_cons">--</b></div>
            <div class="stat-box"><small>COSTO/KM</small><b id="st_cpk">--</b></div>
        </div>
        
        <div style="height:200px; margin-bottom:15px"><canvas id="chart"></canvas></div>

        <div id="list"></div>

        <div class="backup-area">
            <button class="btn-small" style="background:#00695c" onclick="exportBackup()">üì• Backup Dati</button>
            <button class="btn-small" style="background:#2e7d32" onclick="exportExcel()">üìä Excel</button>
            <button class="btn-small" style="background:#d84315" onclick="document.getElementById('impFile').click()">üì§ Ripristina</button>
            <input type="file" id="impFile" hidden accept=".json" onchange="importBackup(this)">
            <button class="btn-small" style="background:#c62828" onclick="wipeDb()">üóëÔ∏è Reset</button>
        </div>
    </div>
</div>

<script>
const DB_NAME = 'peugeot_hdi_v2';
let tempFile = null; // Buffer per file caricato
let chartRef = null;

// --- INIT ---
window.onload = () => {
    document.getElementById('f_date').valueAsDate = new Date();
    document.getElementById('m_date').valueAsDate = new Date();
    render();
};

function switchTab(id) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
    // Trova tab corretto
    const btn = Array.from(document.querySelectorAll('.tab')).find(b => b.onclick.toString().includes(id));
    if(btn) btn.classList.add('active');
    document.getElementById(id).classList.add('active');
    
    // Se stavo modificando e cambio tab, resetto (opzionale, ma pi√π sicuro)
    if(id === 'history') resetAll(); 
}

// --- CALCOLI LIVE ---
function calcFuel() {
    const p = parseFloat(document.getElementById('f_price').value) || 0;
    const l = parseFloat(document.getElementById('f_liters').value) || 0;
    if(p && l) document.getElementById('f_total').value = (p * l).toFixed(2);
}

function calcMaint() {
    const p = parseFloat(document.getElementById('m_parts').value) || 0;
    const l = parseFloat(document.getElementById('m_labor').value) || 0;
    document.getElementById('m_total').value = (p + l).toFixed(2);
}

// --- GESTIONE FILE ---
function loadFile(input, boxId) {
    const box = document.getElementById(boxId);
    const warn = document.getElementById(boxId === 'f_box' ? 'f_warn' : 'm_warn');
    const f = input.files[0];
    
    warn.style.display = 'none';
    tempFile = null;
    box.classList.remove('active');
    box.innerText = "üì∏ Allega Foto/PDF";

    if(f) {
        if(f.size > 1000000) { // 1MB Limit
            warn.style.display = 'block';
            input.value = '';
            return;
        }
        const r = new FileReader();
        r.onload = (e) => {
            tempFile = { name: f.name, data: e.target.result };
            box.innerText = "üìé " + f.name;
            box.classList.add('active');
        };
        r.readAsDataURL(f);
    }
}

// --- SALVATAGGIO ---
function getDb() { return JSON.parse(localStorage.getItem(DB_NAME)) || []; }
function setDb(d) { localStorage.setItem(DB_NAME, JSON.stringify(d)); }

function saveFuel() {
    const id = document.getElementById('f_id').value;
    const km = parseFloat(document.getElementById('f_km').value);
    const lit = parseFloat(document.getElementById('f_liters').value);
    const tot = parseFloat(document.getElementById('f_total').value);
    
    if(!km || !lit || !tot) return alert("Compila Km, Litri e Totale");

    const record = {
        id: id ? parseInt(id) : Date.now(),
        type: 'fuel',
        date: document.getElementById('f_date').value,
        km: km,
        price: parseFloat(document.getElementById('f_price').value),
        lit: lit,
        cost: tot,
        // Se c'√® un file temporaneo usa quello, altrimenti se sto modificando mantieni il vecchio
        file: tempFile || (id ? getDb().find(x=>x.id==id).file : null)
    };
    
    upsert(record);
}

function saveMaint() {
    const id = document.getElementById('m_id').value;
    const km = parseFloat(document.getElementById('m_km').value);
    const tot = parseFloat(document.getElementById('m_total').value);
    
    if(!km || !tot) return alert("Compila Km e Costo Totale");

    const record = {
        id: id ? parseInt(id) : Date.now(),
        type: 'maint',
        subtype: document.getElementById('m_type').value,
        date: document.getElementById('m_date').value,
        km: km,
        parts: parseFloat(document.getElementById('m_parts').value) || 0,
        labor: parseFloat(document.getElementById('m_labor').value) || 0,
        cost: tot,
        notes: document.getElementById('m_notes').value,
        file: tempFile || (id ? getDb().find(x=>x.id==id).file : null)
    };

    upsert(record);
}

function upsert(record) {
    let db = getDb();
    const idx = db.findIndex(x => x.id === record.id);
    if(idx >= 0) db[idx] = record; // Aggiorna
    else db.push(record); // Crea nuovo
    
    db.sort((a,b) => b.km - a.km); // Ordina per Km
    
    try {
        setDb(db);
        alert("Salvato!");
        resetAll();
        switchTab('history');
        render();
    } catch(e) {
        alert("Memoria piena! Impossibile salvare la foto. Prova senza allegato.");
    }
}

// --- MODIFICA ---
function editItem(id) {
    const r = getDb().find(x => x.id === id);
    if(!r) return;

    if(r.type === 'fuel') {
        switchTab('fuel');
        document.getElementById('f_id').value = r.id;
        document.getElementById('f_date').value = r.date;
        document.getElementById('f_km').value = r.km;
        document.getElementById('f_price').value = r.price;
        document.getElementById('f_liters').value = r.lit;
        document.getElementById('f_total').value = r.cost;
        if(r.file) {
            document.getElementById('f_box').innerText = "üìé Documento Esistente";
            document.getElementById('f_box').classList.add('active');
        }
        toggleEditMode('fuel', true);
    } else {
        switchTab('maint');
        document.getElementById('m_id').value = r.id;
        document.getElementById('m_date').value = r.date;
        document.getElementById('m_km').value = r.km;
        document.getElementById('m_type').value = r.subtype;
        document.getElementById('m_parts').value = r.parts || '';
        document.getElementById('m_labor').value = r.labor || '';
        document.getElementById('m_total').value = r.cost;
        document.getElementById('m_notes').value = r.notes || '';
        if(r.file) {
            document.getElementById('m_box').innerText = "üìé Documento Esistente";
            document.getElementById('m_box').classList.add('active');
        }
        toggleEditMode('maint', true);
    }
}

function toggleEditMode(area, isEdit) {
    const parent = document.getElementById(area);
    if(isEdit) parent.classList.add('editing-mode');
    else parent.classList.remove('editing-mode');
    
    const btn = parent.querySelector('.btn-main');
    btn.innerText = isEdit ? "üîÑ Aggiorna Dati" : (area==='fuel' ? "üíæ Salva Rifornimento" : "üíæ Salva Manutenzione");
}

function resetAll() {
    document.querySelectorAll('input').forEach(i => {
        if(i.type !== 'date') i.value = '';
    });
    document.querySelectorAll('textarea').forEach(t => t.value = '');
    document.getElementById('f_id').value = '';
    document.getElementById('m_id').value = '';
    tempFile = null;
    
    document.querySelectorAll('.file-box').forEach(b => {
        b.classList.remove('active');
        b.innerText = b.id.includes('f') ? "üì∏ Allega Foto/PDF" : "üìÑ Allega Documento";
    });

    toggleEditMode('fuel', false);
    toggleEditMode('maint', false);
}

// --- RENDER & EXPORT ---
function render() {
    const db = getDb();
    const list = document.getElementById('list');
    list.innerHTML = "";
    
    let totC = 0, totFuelL = 0;
    let fuels = db.filter(x => x.type === 'fuel');
    let chartLab = [], chartDat = [];

    db.forEach(r => {
        totC += r.cost;
        if(r.type === 'fuel') totFuelL += r.lit;
        
        // Grafico (ultimi 10)
        if(chartLab.length < 10) {
            chartLab.unshift(r.date);
            chartDat.unshift(r.cost);
        }

        const isFuel = r.type === 'fuel';
        const icon = isFuel ? '‚õΩ' : 'üîß';
        const tit = isFuel ? 'Rifornimento' : r.subtype;
        // Dettaglio stringa
        let det = isFuel ? `${r.lit}L (${r.price}‚Ç¨/L)` : `Pezzi: ‚Ç¨${r.parts||0} | Mano: ‚Ç¨${r.labor||0}`;
        if(r.notes) det += `<br><i>${r.notes}</i>`;
        
        let fileLnk = r.file ? `<a href="#" onclick="showFile('${r.id}');return false">üìé Vedi Doc</a>` : '';

        list.innerHTML += `
        <div class="list-item ${isFuel?'type-fuel':'type-maint'}">
            <div class="item-details">
                <h4>${icon} ${tit} <small>${r.date}</small></h4>
                <p>Km: <b>${r.km}</b> | ${det}</p>
                <p>${fileLnk}</p>
            </div>
            <div style="text-align:right">
                <div style="font-weight:bold; font-size:1.1em">‚Ç¨${r.cost.toFixed(2)}</div>
                <div class="item-actions">
                    <button class="btn-icon" onclick="editItem(${r.id})">‚úèÔ∏è</button>
                    <button class="btn-icon" style="color:red" onclick="delItem(${r.id})">üóëÔ∏è</button>
                </div>
            </div>
        </div>`;
    });

    // Stats
    document.getElementById('st_cost').innerText = "‚Ç¨ " + totC.toFixed(0);
    
    // Consumo Medio
    let cons = "--";
    if(fuels.length > 1) {
        let dist = fuels[0].km - fuels[fuels.length-1].km;
        let l_used = 0;
        for(let i=1; i<fuels.length; i++) l_used += fuels[i].lit;
        if(dist > 0 && l_used > 0) cons = (dist/l_used).toFixed(2) + " km/l";
    }
    document.getElementById('st_cons').innerText = cons;
    
    // Costo KM
    let cpk = "--";
    if(db.length > 1) {
        let kmTot = db[0].km - db[db.length-1].km;
        if(kmTot > 0) cpk = "‚Ç¨ " + (totC / kmTot).toFixed(2);
    }
    document.getElementById('st_cpk').innerText = cpk;

    drawChart(chartLab, chartDat);
}

function delItem(id) {
    if(confirm("Eliminare?")) {
        let db = getDb().filter(x => x.id !== id);
        setDb(db);
        render();
    }
}

function showFile(id) {
    const f = getDb().find(x=>x.id==id).file;
    const w = window.open("");
    if(f.data.startsWith("data:app")) w.document.write(`<iframe src="${f.data}" style="width:100%;height:100%"></iframe>`);
    else w.document.write(`<img src="${f.data}" style="width:100%">`);
}

function drawChart(l, d) {
    const ctx = document.getElementById('chart').getContext('2d');
    if(chartRef) chartRef.destroy();
    chartRef = new Chart(ctx, {
        type: 'line',
        data: { labels: l, datasets: [{ label:'Spese (‚Ç¨)', data:d, borderColor:'#002d72', tension:0.3, fill:true, backgroundColor:'rgba(0,45,114,0.1)' }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
}

// --- BACKUP SYSTEM ---
function exportBackup() {
    const data = localStorage.getItem(DB_NAME);
    if(!data) return alert("Nessun dato da salvare.");
    const blob = new Blob([data], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "backup_peugeot_" + new Date().toISOString().split('T')[0] + ".json";
    a.click();
}

function importBackup(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (e) => {
        try {
            JSON.parse(e.target.result); // Validazione JSON
            localStorage.setItem(DB_NAME, e.target.result);
            alert("Backup ripristinato con successo!");
            location.reload();
        } catch(err) {
            alert("File di backup non valido!");
        }
    };
    r.readAsText(f);
}

function exportExcel() {
    const db = getDb();
    let csv = "Data;Tipo;Sottotipo;Km;CostoTot;CostoRicambi;CostoMano;Litri;PrezzoL;Note\n";
    db.forEach(r => {
        csv += `${r.date};${r.type};${r.subtype||''};${r.km};${r.cost};${r.parts||0};${r.labor||0};${r.lit||0};${r.price||0};${r.notes||''}\n`;
    });
    const blob = new Blob([csv], {type: "text/csv"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "export_peugeot.csv";
    a.click();
}

function wipeDb() {
    if(confirm("ATTENZIONE: Cancellerai TUTTI i dati. Continuare?")) {
        localStorage.removeItem(DB_NAME);
        location.reload();
    }
}
</script>
</body>
</html>
